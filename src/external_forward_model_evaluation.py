import torch
from src.custom_algorithms.cleanppofm.forward_model import ProbabilisticForwardNetPositionPrediction, \
    ProbabilisticForwardNetPositionPredictionIncludingReward
import gymnasium as gym
from src.custom_envs.register_envs import register_custom_envs

register_custom_envs()
fm_parameters = {'hidden_size': 256, 'learning_rate': 0.001, 'reward_eta': 0.2}
reward_predicting = True
maximum_number_of_objects = 10
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
env = gym.make('MoonlanderWorld-dodge-gaussian-v0', reward_function="gaussian")
env.reset()

fm_cls = ProbabilisticForwardNetPositionPredictionIncludingReward if reward_predicting else \
    ProbabilisticForwardNetPositionPrediction

if not fm_cls == ProbabilisticForwardNetPositionPredictionIncludingReward:
    fm_network = fm_cls(env, fm_parameters).to(device)
else:
    fm_network = fm_cls(env, fm_parameters, maximum_number_of_objects).to(device)

# cleanppofm_model = torch.load(
#     '/home/annika/coding_projects/Scilab-RL-github/Scilab-RL/policies/collect_23_08_rl_model_best',
#     # '/home/annika/coding_projects/Scilab-RL-github/Scilab-RL/policies/collect_best_fm_23_08_rl_model_best'
#     map_location=torch.device(device))
# fm_network.load_state_dict(cleanppofm_model["_fm"])
fm_network.load_state_dict(torch.load(
    '/home/annika/coding_projects/Scilab-RL-github/Scilab-RL/src/best_model',
    map_location=torch.device(device)))
fm_network.eval()

# example_observations = torch.tensor([[9., 0., 4., 1., 7., 1., 1., 4., 0., 0., 0., 0.],
#                                      [10., 0., 1., 0., 7., 5., 0., 0., 0., 0., 0., 0.],
#                                      [10., 0., 6., 2., 8., 9., 0., 0., 0., 0., 0., 0.],
#                                      [7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [4., 0., 8., 4., 3., 8., 0., 0., 0., 0., 0., 0.],
#                                      [2., 0., 6., 5., 10., 6., 0., 0., 0., 0., 0., 0.],
#                                      [8., 0., 7., 2., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 7., 3., 8., 5., 0., 0., 0., 0., 0., 0.],
#                                      [4., 0., 8., 1., 2., 5., 3., 8., 0., 0., 0., 0.],
#                                      [1., 0., 3., 0., 7., 3., 7., 5., 0., 0., 0., 0.],
#                                      [3., 0., 4., 5., 8., 7., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 2., 0., 5., 2., 0., 0., 0., 0., 0., 0.],
#                                      [10., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [10., 0., 1., 4., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [6., 0., 1., 0., 2., 4., 3., 7., 0., 0., 0., 0.],
#                                      [8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [8., 0., 3., 5., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [9., 0., 6., 3., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [2., 0., 9., 1., 1., 9., 2., 9., 0., 0., 0., 0.],
#                                      [1., 0., 7., 1., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [9., 0., 9., 5., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [2., 0., 10., 0., 4., 3., 5., 7., 0., 0., 0., 0.],
#                                      [6., 0., 10., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [10., 0., 3., 2., 4., 2., 0., 0., 0., 0., 0., 0.],
#                                      [3., 0., 4., 1., 8., 9., 0., 0., 0., 0., 0., 0.],
#                                      [3., 0., 8., 2., 9., 5., 0., 0., 0., 0., 0., 0.],
#                                      [3., 0., 3., 3., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [10., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [4., 0., 5., 6., 9., 6., 0., 0., 0., 0., 0., 0.],
#                                      [7., 0., 7., 8., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [9., 0., 10., 1., 10., 5., 10., 6., 9., 9., 0., 0.],
#                                      [7., 0., 2., 5., 1., 8., 2., 9., 0., 0., 0., 0.],
#                                      [1., 0., 2., 4., 10., 6., 0., 0., 0., 0., 0., 0.],
#                                      [4., 0., 5., 0., 2., 1., 0., 0., 0., 0., 0., 0.],
#                                      [2., 0., 4., 1., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [9., 0., 3., 8., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [6., 0., 8., 4., 6., 6., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 7., 1., 10., 2., 1., 3., 0., 0., 0., 0.],
#                                      [8., 0., 5., 5., 6., 9., 0., 0., 0., 0., 0., 0.],
#                                      [3., 0., 6., 8., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [7., 0., 3., 3., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 9., 2., 7., 3., 5., 8., 0., 0., 0., 0.],
#                                      [10., 0., 1., 0., 10., 5., 10., 8., 0., 0., 0., 0.],
#                                      [3., 0., 3., 4., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [9., 0., 6., 1., 7., 2., 0., 0., 0., 0., 0., 0.],
#                                      [3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [3., 0., 10., 0., 2., 8., 0., 0., 0., 0., 0., 0.],
#                                      [10., 0., 8., 2., 3., 8., 0., 0., 0., 0., 0., 0.],
#                                      [9., 0., 6., 2., 7., 3., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 8., 9., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [4., 0., 1., 4., 5., 4., 5., 5., 0., 0., 0., 0.],
#                                      [7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [5., 0., 8., 2., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 5., 4., 7., 8., 0., 0., 0., 0., 0., 0.],
#                                      [5., 0., 8., 3., 7., 7., 0., 0., 0., 0., 0., 0.],
#                                      [8., 0., 1., 0., 6., 4., 0., 0., 0., 0., 0., 0.],
#                                      [8., 0., 2., 8., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [1., 0., 6., 1., 1., 9., 0., 0., 0., 0., 0., 0.],
#                                      [6., 0., 5., 5., 0., 0., 0., 0., 0., 0., 0., 0.],
#                                      [4., 0., 1., 2., 2., 6., 3., 9., 0., 0., 0., 0.],
#                                      [4., 0., 2., 2., 1., 3., 10., 7., 0., 0., 0., 0.],
#                                      [3., 0., 1., 1., 7., 6., 0., 0., 0., 0., 0., 0.],
#                                      [2., 0., 3., 6., 4., 7., 0., 0., 0., 0., 0., 0.]])
actions = torch.tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1])

example_observations = torch.tensor(
    [[9., 0., 4., 1., 7., 1., 1., 4., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 1., 0., 7., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 6., 2., 8., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 8., 4., 3., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [2., 0., 6., 5., 10., 6., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [8., 0., 7., 2., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 7., 3., 8., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 8., 1., 2., 5., 3., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 3., 0., 7., 3., 7., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 4., 5., 8., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 2., 0., 5., 2., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 1., 4., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [6., 0., 1., 0., 2., 4., 3., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [8., 0., 3., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [9., 0., 6., 3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [2., 0., 9., 1., 1., 9., 2., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 7., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [9., 0., 9., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [2., 0., 10., 0., 4., 3., 5., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [6., 0., 10., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 3., 2., 4., 2., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 4., 1., 8., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 8., 2., 9., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 3., 3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 5., 6., 9., 6., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [7., 0., 7., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [9., 0., 10., 1., 10., 5., 10., 6., 9., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [7., 0., 2., 5., 1., 8., 2., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 2., 4., 10., 6., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 5., 0., 2., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [2., 0., 4., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [9., 0., 3., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [6., 0., 8., 4., 6., 6., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 7., 1., 10., 2., 1., 3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [8., 0., 5., 5., 6., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 6., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [7., 0., 3., 3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 9., 2., 7., 3., 5., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 1., 0., 10., 5., 10., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 3., 4., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [9., 0., 6., 1., 7., 2., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 10., 0., 2., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [10., 0., 8., 2., 3., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [9., 0., 6., 2., 7., 3., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 8., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 1., 4., 5., 4., 5., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [5., 0., 8., 2., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 5., 4., 7., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [5., 0., 8., 3., 7., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [8., 0., 1., 0., 6., 4., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [8., 0., 2., 8., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [1., 0., 6., 1., 1., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [6., 0., 5., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 1., 2., 2., 6., 3., 9., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [4., 0., 2., 2., 1., 3., 10., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [3., 0., 1., 1., 7., 6., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
     [2., 0., 3., 6., 4., 7., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]])

state_normal_distribution = fm_network(example_observations, actions.float().unsqueeze(1))
for index, element in enumerate(example_observations):
    print(element[0], torch.round(state_normal_distribution.mean[index][0]))
    if element[0] != torch.round(state_normal_distribution.mean[index][0]):
        print("Error")
